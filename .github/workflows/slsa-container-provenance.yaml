name: SLSA Container Provenance

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
    env:
      BASE_DIR: ${{ secrets.BASE_DIR || 'src/' }}
      BUILDPACK_BUILDER: ${{ secrets.BUILDPACK_BUILDER || 'gcr.io/buildpacks/builder' }}
      DOCKER_HUB_IMAGE_TAG: ${{ secrets.DOCKER_HUB_IMAGE_TAG || github.sha }}
      DOCKER_HUB_REPO: ${{ secrets.DOCKER_HUB_REPO || github.repository }}
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-name: ${{ steps.build.outputs.name }}
      registry-username: ${{ steps.registry.outputs.username }}
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Pack CLI
      uses: buildpacks/github-actions/setup-pack@v5.0.0

    - name: Build app using Buildpacks
      id: build
      run: |
        IMAGE_NAME="${{ env.DOCKER_HUB_REPO }}:${{ env.DOCKER_HUB_IMAGE_TAG }}"
        
        pack build ${IMAGE_NAME} \
          --path ${{ env.BASE_DIR }} \
          --env "DISABLE_COLLECTSTATIC=1" \
          --builder ${{ env.BUILDPACK_BUILDER }}
        
        # Get the image digest
        DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${IMAGE_NAME} | cut -d'@' -f2 || docker inspect --format='{{.Id}}' ${IMAGE_NAME})
        echo "digest=${DIGEST}" >> "${GITHUB_OUTPUT}"
        echo "name=${IMAGE_NAME}" >> "${GITHUB_OUTPUT}"
        
        # Save image for attestation
        docker save ${IMAGE_NAME} -o /tmp/container-image.tar

    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.7.0
      with:
        cosign-release: 'v2.4.0'

    - name: Login to Docker Hub
      id: registry
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}
    
    - name: Set registry username output
      run: echo "username=${{ secrets.DOCKER_HUB_USERNAME }}" >> "${GITHUB_OUTPUT}"

    - name: Push container to Docker Hub
      run: |
        docker push ${{ env.DOCKER_HUB_REPO }}:${{ env.DOCKER_HUB_IMAGE_TAG }}

    - name: Sign container image with Cosign
      env:
        COSIGN_EXPERIMENTAL: 1
      run: |
        echo "Signing container image with GitHub OIDC..."
        cosign sign --yes \
          --oidc-issuer=https://token.actions.githubusercontent.com \
          --oidc-client-id=sigstore \
          ${{ env.DOCKER_HUB_REPO }}:${{ env.DOCKER_HUB_IMAGE_TAG }}
        echo "Container image signed successfully!"

    - name: Tag and push latest
      run: |
        docker tag ${{ env.DOCKER_HUB_REPO }}:${{ env.DOCKER_HUB_IMAGE_TAG }} ${{ env.DOCKER_HUB_REPO }}:latest
        docker push ${{ env.DOCKER_HUB_REPO }}:latest

    - name: Generate container SBOM
      run: |
        # Extract dependencies from requirements.txt
        cd ${{ env.BASE_DIR }}
        echo "Generating SBOM from requirements.txt..."
        cat requirements.txt

    - name: Upload container artifact for attestation
      uses: actions/upload-artifact@v4
      with:
        name: container-image
        path: /tmp/container-image.tar
        retention-days: 1

  # Generate SLSA provenance for the container
  provenance:
    needs: [build]
    permissions:
      actions: read
      id-token: write
      contents: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0
    with:
      image: ${{ needs.build.outputs.image-name }}
      digest: ${{ needs.build.outputs.image-digest }}
      registry-username: ${{ needs.build.outputs.registry-username }}
    secrets:
      registry-password: ${{ secrets.DOCKER_HUB_TOKEN }}

  # Verify both Cosign signature and SLSA provenance
  verify:
    needs: [build, provenance]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.7.0

    - name: Install slsa-verifier
      run: |
        wget https://github.com/slsa-framework/slsa-verifier/releases/download/v2.6.0/slsa-verifier-linux-amd64
        chmod +x slsa-verifier-linux-amd64
        sudo mv slsa-verifier-linux-amd64 /usr/local/bin/slsa-verifier

    - name: Verify Cosign signature
      env:
        COSIGN_EXPERIMENTAL: 1
      run: |
        echo "Verifying Cosign signature..."
        cosign verify \
          --certificate-identity-regexp="^https://github.com/${{ github.repository }}" \
          --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
          ${{ needs.build.outputs.image-name }}
        echo "✅ Cosign signature verified!"

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Verify SLSA provenance
      run: |
        echo "Verifying SLSA provenance..."
        slsa-verifier verify-image \
          ${{ needs.build.outputs.image-name }} \
          --source-uri github.com/${{ github.repository }} \
          --source-branch main
        echo "✅ SLSA provenance verified!"
